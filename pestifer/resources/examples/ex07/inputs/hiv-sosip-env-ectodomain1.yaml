# Author: Cameron F. Abrams, <cfa22@drexel.edu>
#
# pestifer input script
# 
# Simple build of solvated HIV-1 Env SOSIP ectodomain trimer 4zmj
#
# Notes:
#   - Chain G produces daughter chains H and J upon BIOMT transformation to build trimer
#   - Chain B produces daughter chains C and D upon BIOMT transformation to build trimer
#   - Existing chains C and D (these are glycans) are assigned new chainIDs
#   - All glycans are assigned chainIDs that are not shared with any protein
#   - Missing protein is built-in
#   - Fine-tuning ramachandran rotations performed at N-terminus of HN1
#     to avoid steric clashes when building in these missing residues
#   - A five-phase NPT equilibration is used to settle the density
#   - A production tarball is generated: prod_4zmj.tgz
#
title: Closed, Unliganded HIV-1 BG505 Env SOSIP-664 Trimer
tasks:
  - fetch:
      sourceID: 4zmj
  - psfgen:
      source:
        biological_assembly: 1
        transform_reserves:
          G: [H,J]
          B: [C,D]
      mods:
        mutations:  # undo the SOSIP mutations
          - G:CYS,501,ALA
          - B:PRO,559,ILE
          - B:CYS,605,THR
        crotations:
          - psi,B,546,568,-180.0
          - phi,B,547,568,-60.0
  - validate:
      tests:
        - attribute_test:
            name: point mutation
            selection: protein and chain G H J and resid 501 and name CA
            attribute: resname
            value: ALA
            value_count: 3
        - attribute_test:
            name: point mutation
            selection: protein and chain B C D and resid 559 and name CA
            attribute: resname
            value: ILE
            value_count: 3
        - attribute_test:
            name: point mutation
            selection: protein and chain B C D and resid 605 and name CA
            attribute: resname
            value: THR
            value_count: 3
  - md:
      ensemble: minimize
  - ligate:
      steer:
        nsteps: 4200
  - validate:
      tests:
        - connection_test:
            name: gp120 gaps ligation
            selection: protein and chain G H J and ((resid 185 and insertion I) or resid 187 410 411)
            connection_type: interresidue
            connection_count: 6
        - connection_test:
            name: gp41 gaps ligation
            selection: protein and chain B C D and resid 568 569
            connection_type: interresidue
            connection_count: 3
  - md:
      ensemble: minimize
  - md:
      cpu-override: True
      ensemble: NVT
      nsteps: 2400
  - solvate:
  - md:
      ensemble: minimize
  - md:
      ensemble: NVT
  - md:
      ensemble: NPT
      nsteps: 200
  - md:
      ensemble: NPT
      nsteps: 400
  - md:
      ensemble: NPT
      nsteps: 800
  - md:
      ensemble: NPT
      nsteps: 1600
  - md:
      ensemble: NPT
      nsteps: 13200
  - mdplot:
      timeseries:
        - density
        - - a_x
          - b_y
          - c_z
      grid: True
      basename: solvated
  - terminate:
      basename: my_4zmj
      archive_dir: arc
      package:
        basename: prod_4zmj
        state_dir: r2r
        md:
          ensemble: NPT