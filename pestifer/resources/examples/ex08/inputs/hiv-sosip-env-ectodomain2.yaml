# Author: Cameron F. Abrams, <cfa22@drexel.edu>
#
# pestifer input script
# 
# Simple build of solvated HIV-1 Env SOSIP ectodomain trimer 4tvp
#
# Notes:
#   - Missing protein is built-in
#   - Fab chains are excluded (along with their associated waters and sulfate ions)
#   - Sulfate ions and waters associated with gp120 and gp41 are retained
#   - Glycan stems are retained
#   - mmCIF format numbering is used (this is different from HXB2 numbering)
#   - A five-phase NPT equilibration is used to settle the density
#   - A production tarball is generated: prod_4tvp.tgz
#
title: Closed, PGT122/35O22-Liganded HIV-1 BG505 Env SOSIP.664 Trimer (Fabs removed)
tasks:
  - fetch:
      sourceID: 4tvp
      source_format: cif
  - psfgen:
      source:
        biological_assembly: 1
        exclude: # the four fab chains, the one fab glycan, and waters and sulfates associated with fabs
          - chainID in ['C', 'D', 'E', 'F', 'LA', 'KA', 'OA', 'PA', 'QA', 'RA']
        transform_reserves:
          A: [C, E] # gp120's
          B: [D, F] # gp41's
      mods:
        mutations:  # undo the SOSIP mutations (CIF label numbering)
          - A:CYS,469,ALA
          - B:CYS,94,THR
          - B:PRO,48,ILE
        crotations: # reporient the modeled-in chain to avoid clashes
          - psi,B,35,57,-180
          - phi,B,35,57,-60
          - phi,B,39,57,-30
  - validate:
      tests:
        - attribute_test:
            name: point mutation
            selection: protein and chain A C E and resid 469 and name CA
            attribute: resname
            value: ALA
            value_count: 3
        - attribute_test:
            name: point mutation
            selection: protein and chain B D F and resid 48 and name CA
            attribute: resname
            value: ILE
            value_count: 3
        - attribute_test:
            name: point mutation
            selection: protein and chain B D F and resid 94 and name CA
            attribute: resname
            value: THR
            value_count: 3
  - md:
      ensemble: minimize
      nsteps: 3000
  - md:
      ensemble: NVT
      nsteps: 2000
  - ligate:
      steer:
        force_constant: 10
        nsteps: 6000
  - validate:
      tests:
        - connection_test:
            name: gp120 gaps ligation
            selection: protein and chain A C E and ((resid 156 and insertion I) or resid 157 378 379)
            connection_type: interresidue
            connection_count: 6
        - connection_test:
            name: gp41 gaps ligation
            selection: protein and chain B D F and resid 57 58
            connection_type: interresidue
            connection_count: 3
  - md:
      ensemble: minimize
      nsteps: 3000
  - md:
      cpu-override: True
      ensemble: NVT
      nsteps: 2000
  - solvate:
  - md:
      ensemble: minimize
  - md:
      ensemble: NVT
  - md:
      ensemble: NPT
      nsteps: 200
  - md:
      ensemble: NPT
      nsteps: 400
  - md:
      ensemble: NPT
      nsteps: 800
  - md:
      ensemble: NPT
      nsteps: 1600
  - md:
      ensemble: NPT
      nsteps: 13200
  - mdplot:
      timeseries:
        - density
      basename: solvated
      grid: True
  - terminate:
      basename: my_4tvp
      archive_dir: arc
      package:
        basename: prod_4tvp
        state_dir: r2r
        md:
          ensemble: NPT