# Author: Cameron F. Abrams, <cfa22@drexel.edu>
#
# pestifer input script
# 
# Membrane-embedded build of HIV-1 gp41 MPER-TM trimer (6e8w)
#
#
title: HIV-1 gp41 MPER-TM trimer 6e8w embedded in DMPC bilayer
tasks:
  - fetch:
      sourceID: 6e8w
  - psfgen:
      source:
        model: 15 # last frame
  - md:
      cpu-override: True
      ensemble: minimize
  - make_membrane_system:
      bilayer:
        salt_con: 0.154
        cation: POT
        anion: CLA
        half_mid_zgap: 0.0
        SAPL: 60.0
        composition:
          lower_leaflet:
            - name: DMPC
              frac: 1.00
          upper_leaflet:
            - name: DMPC
              frac: 1.00
        seed: 270272
        nloop: 100
        nloop_all: 100
        relaxation_protocols:
          patch:
            - md:
                ensemble: minimize
                nsteps: 1000
            - md:
                ensemble: NVT
                nsteps: 1000
                temperature: 310
            - md:
                ensemble: NPT
                nsteps: 500
                temperature: 310
                pressure: 10.0
            - md:
                ensemble: NPT
                nsteps: 500
                temperature: 310
                pressure: 10.0
            - md:
                ensemble: NPT
                nsteps: 1000
                temperature: 310
                pressure: 10.0
            - md:
                ensemble: NPT
                nsteps: 1000
                temperature: 310
                pressure: 10.0
            - md:
                ensemble: NPT
                nsteps: 4000
                temperature: 310
                pressure: 10.0
            - md:
                ensemble: NPT
                nsteps: 8000
                temperature: 310
                pressure: 10.0
            - md:
                ensemble: NPAT
                nsteps: 16000  # this is (probably) too short!
                temperature: 310
                pressure: 1.0
          quilt:
            - md:
                ensemble: minimize
            - md:
                ensemble: NVT
                nsteps: 1000
                temperature: 310
                pressure: 1.0
            - md:
                ensemble: NPAT
                nsteps: 2000
                temperature: 310
                pressure: 1.0
      embed:
        xydist: 20
        zdist: 10
        z_head_group: "protein and resid 667"
        z_tail_group: "protein and resid 710"
        z_ref_group: 
          text: "protein and resid 696"
          z_value: 0.0
  - validate:
      tests:
        - residue_test:
            name: test of protein presence
            selection: protein
            measure: residue_count
            relation: '>='
            value: 1
  - md:
      ensemble: minimize
      minimize: 1000
      constraints:
        k: 10
        atoms: protein and name CA
  - md:
      ensemble: NVT
      nsteps: 1000
      temperature: 410
      constraints:
        k: 10
        atoms: protein and name CA
  - md:
      ensemble: NVT
      nsteps: 1000
      temperature: 410
      constraints:
        k: 1
        atoms: protein and name CA
  - md:
      ensemble: NPT
      nsteps: 6400
      temperature: 410
  - md:
      ensemble: NPAT
      nsteps: 51200  # this is (probably) way too short!!
      temperature: 310
      other_parameters:
        pressureProfile: on
        pressureProfileFreq: 100
        pressureProfileSlabs: 20
  - mdplot:
      timeseries:
        - - cpu_time
          - wall_time
        - density
        - - a_x
          - b_y
          - c_z
      profiles:
        - pressure
      basename: bilayer
      grid: True
      legend: True
  - terminate:
      basename: my_6e8w
      archive_dir: arc
      package:
        state_dir: r2r
        basename: prod_6e8w
        md:
          ensemble: NPAT
          firsttimestep: 0
          dcdfreq: 10000
          xstfreq: 10000
          outputenergies: 1000
          nsteps: 10000000
          other_parameters:
            pressureProfile: on
            pressureProfileFreq: 10000 # must equal xstfreq!
            pressureProfileSlabs: 20
