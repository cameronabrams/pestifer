# Author: Cameron F. Abrams, <cfa22@drexel.edu>
#
# pestifer input script
# 
# Simple build of solvated HIV-1 Env trimer 5vn3
#
# Notes:
#   - Missing protein is built-in
#   - Fab and sCD4 chains excluded
#   - Missing V1/2 residues in each gp120 replaced with GGG
#   - A five-phase NPT equilibration is used to settle the density
#   - A production tarball is generated: prod_5vn3.tgz
#
title: HIV-1 Env Trimer 5vn3, excluding sCD4 and Fab chains, with Gly3 stubs replacing missing v1/2
tasks:
  - fetch:
      sourceID: 5vn3
      source_format: pdb
  - psfgen:
      source:
        biological_assembly: 1
        exclude:
          - chainID in ['C', 'H', 'L', 'E', 'K', 'N', 'F', 'M', 'O']
      mods:
        mutations:  # undo the SOSIP mutations
          - G:CYS,501,ALA
          - I:CYS,501,ALA
          - J:CYS,501,ALA
          - A:PRO,559,ILE
          - B:PRO,559,ILE
          - D:PRO,559,ILE
          - A:CYS,605,THR
          - B:CYS,605,THR
          - D:CYS,605,THR
        substitutions: # stub out missing V1/2
          - G:131A-133T,GGG
          - I:131A-133T,GGG
          - J:131A-133T,GGG
        crotations:
          - phi,G,309,324,-60
          - phi,I,309,324,-60
          - phi,J,309,324,-60
  - validate:
      tests:
        - attribute_test:
            name: undo sos mutation on gp120
            selection: protein and chain G I J and resid 501 and name CA
            attribute: resname
            value: ALA
            value_count: 3
        - attribute_test:
            name: undo ip mutation on gp41
            selection: protein and chain A B D and resid 559 and name CA
            attribute: resname
            value: ILE
            value_count: 3
        - attribute_test:
            name: undo sos mutation on gp41
            selection: protein and chain A B D and resid 605 and name CA
            attribute: resname
            value: THR
            value_count: 3
        - attribute_test:
            name: g120 v1/2 stubs
            selection: protein and chain G I J and resid 131A 131B 131C and name CA
            attribute: resname
            value: GLY
            value_count: 9
  - md:
      cpu-override: True
      ensemble: minimize
  - ligate:
      steer:
        nsteps: 3000
  - validate:
      tests:
        - connection_test:
            name: g120 gap ligations
            selection: protein and chain G I J and resid 324 325 411 412
            connection_type: interresidue
            connection_count: 6
        - connection_test:
            name: gp41 gap ligations
            selection: protein and chain A B D and resid 562 563
            connection_type: interresidue
            connection_count: 3
  - md:
      cpu-override: True
      ensemble: minimize
  - md:
      cpu-override: True
      ensemble: NVT
      nsteps: 2400
  - solvate:
  - md:
      ensemble: minimize
  - md:
      ensemble: NVT
  - md:
      ensemble: NPT
      nsteps: 200
  - md:
      ensemble: NPT
      nsteps: 400
  - md:
      ensemble: NPT
      nsteps: 800
  - md:
      ensemble: NPT
      nsteps: 1600
  - md:
      ensemble: NPT
      nsteps: 13200
  - mdplot:
      timeseries:
        - density
      basename: solvated
      grid: True
  - terminate:
      basename: my_5vn3
      archive_dir: arc
      package:
        basename: prod_5vn3
        state_dir: r2r
        md:
          ensemble: NPT